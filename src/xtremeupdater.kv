#:kivy 1.10.1

#:import main main
#:import theme theme.theme
#:import Window kivy.core.window.Window
#:import DllViewAdapter main.DllViewAdapter
#:import Tweaks tweaks.Tweaks
#:import get_version_number get_version_number.get_version_number
#:import HoveringBehavior hovering_behavior.HoveringBehavior
#:import startfile os.startfile
#:import version main.__version__
#:import __file__ main.__file__
#:import dirname os.path.dirname
#:import Factory kivy.factory.Factory
#:import platform platform

RootLayout:
<CustButton>:
    background_normal: 'img/FFFFFF-1.png'
    background_disabled_normal: self.background_normal
    background_down: self.background_normal
    background_disabled_down: self.background_normal
    background_color: 0, 0, 0, 0

<BackgroundedButton@CustButton>:
    background_color: theme.bg
    background_color_hovering: theme.dark
    font_size: 24

<HeaderLabel>:
    text: '[color=ddd]Xtreme[/color]Updater'
    font_name: 'fnt/Roboto-Black.ttf'
    text_size: self.size
    halign: 'left'
    padding: 10, 5
    color: theme.prim
    markup: True
    noise_color: Window.clearcolor

<HeaderMiniLabel>:
    color: theme.bg
    size: 40, 40
    font_name: 'fnt/segmdl2.ttf'
    font_size: 20

    canvas.before:
        PushMatrix
        Rotate:
            angle: self.rotation_angle
            origin: self.center
    
    canvas.after:
        PopMatrix
        
<ContentLayout@BoxLayout+NoiseTexture>:
    orientation: 'vertical'
    noise_color: theme.dark

    canvas.before:
        Color:
            rgba: theme.dark

        Rectangle:
            pos: self.pos
            size: self.size

<HeaderButton@CustButton+NoiseTexture>:
    size_hint_x: None
    width: self.height
    noise_color: Window.clearcolor

<IconButton@CustButton>:
    size_hint_x: None
    width: self.height
    font_name: 'fnt/segmdl2.ttf'
    font_size: 20

<NavigationButton>:
    markup: True
    size_hint_x: None
    width: 120
    highlight_width: self.width * self.highlight_width_ratio
    bold: True
    font_size: 17
    color_hovering: theme.prim

    canvas.before:
        Color:
            rgba: root.highlight_color

        Rectangle:
            pos: self.x + (self.width - self.highlight_width) / 2, self.y
            size: self.highlight_width, self.highlight_height

<IconNavigationButton@IconButton+NavigationButton>:
    font_size: 18
    icon: self.text

<Navigation>:
    size_hint_y: None
    height: 40
    noise_color: theme.dark

<OverdrawLabel>:
    size_hint: None, None
    size: 0, 0
    opacity: 0

    Label:
        id: label

        canvas.before:
            Color:
                rgba: theme.sec

            Rectangle:
                pos: self.pos
                size: self.size

            PushMatrix
            Rotate:
                angle: root.angle
                origin: self.center

        canvas.after:
            PopMatrix

        pos: root.widget.pos
        size_hint: None, None
        size: root.widget.size
        color: theme.prim
        markup: True
        font_size: 36
        text_size: self.size
        text: root.TEMPLATE.format(root.icon, root.text)
        halign: 'center'
        valign: 'center'
        opacity: root.opacity

<Content@PageLayout>:
    border: 0

<DllViewItem>:
    text_size: self.size
    valign: 'center'
    padding: 40, 0
    background_normal: 'img/FFFFFF-1.png'
    background_down: self.background_normal
    selected_color: theme.prim
    deselected_color: theme.sec
    color: theme.fg
    size_hint_y: None
    height: 25

    Label:
        text: get_version_number(app.root.path + root.text)
        pos: root.pos
        size: root.size
        text_size: self.size
        halign: 'right'
        valign: 'center'
        padding: root.padding
        color: root.color

<Scrollview>:
    scroll_wheel_distance: 100
    bar_width: 10
    bar_color: theme.sec
    bar_inactive_color: [0, 0, 0, 0]
    scroll_type: ['content', 'bars']

<DllView@ListView, ScrollView>:
    bar_color: theme.bg

    adapter:
        DllViewAdapter(
        data=[],
        args_converter=lambda index, item: {'text': item},
        cls='DllViewItem',
        selection_mode='multiple'
        )

<SubdirItem>:
    text: '...' + self.path
    background_normal: 'img/FFFFFF-0.png'
    background_down: 'img/FFFFFF-0.png'
    text_size: self.size
    valign: 'center'
    padding: 40, 0
    on_release: app.root.load_dll_view_data(app.root.path + self.path)
    shorten: True

    canvas.before:
        Color:
            rgba: theme.prim
            a: root.highlight_alpha
        
        Rectangle:
            pos: self.pos
            size: self.highlight_width, self.height

<SubdirView@RecycleView>:
    bar_color: theme.prim

    viewclass: 'SubdirItem'

    RecycleBoxLayout:
        default_size: None, 25
        default_size_hint: 1, None
        size_hint_y: None
        height: self.minimum_height
        orientation: 'vertical'

<DllActionButton@CustButton>:
    size_hint_x: None
    bold: True
    text_size: self.size
    halign: 'center'
    valign: 'bottom'
    padding: 0, 6
    disabled: True

<GameButton>:
    background_normal: 'img/FFFFFF-1.png'
    background_down: self.background_normal
    color: 0, 0, 0, 0
    background_color: 0, 0, 0, 0
    size_hint: None, None
    size: 333, 187

    AsyncImage:
        id: image
        pos: root.pos
        size: root.width, root.height
        nocache: True

    Label:
        id: label
        padding: 20, 5
        text: root.text
        pos: root.pos
        size: root.size
        valign: 'bottom'
        text_size: self.size
        font_name: 'fnt/Roboto-Black.ttf'
        size_hint_y: None
        height: 30
        color: theme.prim

        canvas.before:
            Color:
                rgba: theme.dark
            
            Rectangle:
                pos: self.pos
                size: self.size

    IconButton:
        text: '\ue768'
        x: root.x + root.width - self.width
        y: root.y + root.height - self.height
        size: 40, 40
        opacity: float(root.hovering)
        disabled: not root.exe 
        on_release: root.launch_game()

    IconButton:
        text: '\ue74d'
        x: root.x + root.width - self.width * 2
        y: root.y + root.height - self.height
        size: 40, 40
        opacity: float(root.hovering and root.custom)
        disabled: not root.custom
        on_release: root.remove_from_collection()

<GameCollection>:
    padding: 40, 0
    size: self.parent.size
    effect_cls: 'OpacityScrollEffect'

    StackLayout:
        id: board
        size_hint_y: None
        height: self.minimum_height

<LabelIconButton>:
    command: lambda: None
    font_size: 16

    canvas.before:
        Color:
            rgba: theme.bg

        Rectangle:
            pos: self.pos
            size: self.size

    size_hint: None, None
    size: 340, 40

    IconButton:
        id: button
        text: root.icon
        on_release: root.command()

    Label:
        id: label
        padding: 10, 0
        text: root.text
        markup: True
        text_size: self.size
        valign: 'center'
        font_size: root.font_size

<SectionLabel@Label>:
    color: theme.sec
    font_size: 15
    size_hint_y: None
    height: 30
    text_size: self.size
    padding: 0, 2

    canvas:
        Color:
            rgb: root.color

        Line:
            points: root.x, root.y, root.x + root.width, root.y

<CustTextInput@TextInput>:
    size_hint_x: None
    width: 340
    multiline: False
    background_color: theme.sec
    background_normal: 'img/FFFFFF-0'
    background_active: 'img/FFFFFF-0'
    cursor_color: theme.prim
    selection_color: theme.prim[:-1] + [.2]
    font_size: 15
    foreground_color: theme.fg
    padding: 11, 11

<PathInput@CustTextInput>:
    size_hint_x: 1
    background_color: theme.dark
    foreground_color: theme.sec
    on_text_validate: app.root.load_dll_view_data(self.text)

<SyncPopup>:
    size_hint: 1, None
    height: Window.height - app.root.ids.header.height
    pos_hint: {'y': 0}
    title: ''
    separator_height: 0
    background_color: 0, 0, 0, 0
    noise_color: theme.sec
    background: 'img/FFFFFF-0.png'
    text: 'Syncing with GitHub..'

    BoxLayout:
        orientation: 'vertical'

        Widget:
            size_hint_y: None
            height: 140

        Label:
            text: '\ue895'
            font_name: 'fnt/segmdl2.ttf'
            font_size: 72
            color: theme.prim
            text_size: self.size
            halign: 'center'
            valign: 'center'
            size_hint_y: None
            height: 100

            canvas.before:
                PushMatrix
                Rotate:
                    angle: root.icon_rotation
                    origin: self.center

            canvas.after:
                PopMatrix

        Label:
            text: root.text
            font_size: 36
            text_size: self.size
            halign: 'center'
            valign: 'top'
            color: theme.prim

<CustPopup>:
    final_size_hint: .8, .8
    background: 'img/FFFFFF-0.png'
    background_color: 0, 0, 0, 0
    opacity: 0
    title_size: 32
    separator_height: 1 
    separator_color: self.title_color

    canvas.before:
        Color:
            rgb: .8, .8, .8
        Rectangle:
            group: 'blur'
            size: Window.size

<ErrorPopup>:
    title_color: 1, .3, .3, 1
    icon: '\ue783'

    BoxLayout:
        orientation: 'vertical'

        ScrollView:
            Label:
                text: root.message
                text_size: self.width, None
                valign: 'top'
                padding: 10, 10
                markup: True
                size_hint_y: None
                height: self.texture_size[1]
        Widget:
            size_hint_y: .4

<AcceptDecliene@BoxLayout>:
    size_hint_y: None
    height: 70

    Widget

    IconButton:
        text: '\ue711'
        color_hovering: 1, .3, .3, 1
        on_release: root.decline_command()

    IconButton:
        text: '\ue8fb'
        color_hovering: .3, 1, .3, 1
        on_release: root.proceed_command()

<GameRemovePopup>:
    title: f'Remove [color={theme.PRIM}]{root.game}[/color]'
    title_color: 1, .3, .3, 1
    icon: '\uecc9'

    AcceptDecliene:
        pos: root.x + root.width - self.width - 10, root.y + 10
        proceed_command: root.proceed_command
        decline_command: root.dismiss

<UninstallPopup@CustPopup>:
    title: f'[color=#f55]Uninstall[/color] [color={theme.PRIM}]XtremeUpdater[/color] ?'
    separator_color: 1, .3, .3, 1
    icon: '\uecc9'

    AcceptDecliene:
        pos: root.x + root.width - self.width - 10, root.y + 10
        proceed_command: app.root.uninstall
        decline_command: root.dismiss

<DisclaimerPopup@CustPopup>:
    title: 'Disclaimer'
    title_color: 1, 1, 0, 1
    separator_color: 1, 1, 0, 1
    icon: '\ue7ba'
    final_size_hint: .9, .9

    BoxLayout:
        orientation: 'vertical'

        Label:
            text: open(dirname(__file__) + '\\LICENSE').read()
            text_size: self.size
            padding: 10, 0
            size_hint_x: None
            width: 800

        BoxLayout:
            padding: 10

            Widget

            BackgroundedButton:
                text: 'I understand'
                on_release: root.dismiss()
                size_hint: None, None
                size: 200, 40

            Widget

<CustSwitch>:
    size_hint: None, None
    size: 40, 40
    canvas:
        Color:
            rgba: theme.prim

        Rectangle:
            size: self.width / 2, self.height
            pos: self.pos

        Color:
            rgba: theme.bg

        Rectangle:
            size: self.width / 2, self.height
            pos: self.x + self.width / 2, self.y

        Color:
            rgba: theme.sec

        Rectangle:
            source: 'img/FFFFFF-1.png'
            size: 20, self.height + 6
            pos: self.x + self._switch_x, self.y - 3

    Label:
        text: '\ue72e'
        font_name: 'fnt/segmdl2.ttf'
        pos: root.x + root._switch_x, root.y + 4
        size: 20, 10
        opacity: float(root.disabled)
        color: theme.bg
        font_size: 16

<LabelSwitch>:
    size_hint: 0, 0
    size: 340, 40

    canvas:
        Color:
            rgba: theme.bg

        Rectangle:
            pos: self.pos
            size: self.size

    CustSwitch:
        id: switch
        size_hint_x: None
        color: theme.prim
        active: root.active

    Label:
        text: root.text
        text_size: self.size
        valign: 'center'
        padding: 10, 0

<WorkingBar>:
    canvas:
        Color:
            rgba: root.color

        Line:
            points: [self._x1 * self.width, self.y + 1, self._x2 * self.width, self.y + 1]
            width: 1.2
            cap: 'none'


<LaunchNowButton>:
    text: 'Play now'
    font_name: 'fnt/Roboto-Black.ttf'
    font_size: 24
    markup: True
    size_hint: 1, None
    height: 60
    text_size: self.size
    halign: 'center'
    background_color: theme.sec
    background_color_hovering: theme.sec
    underline: True
    color: [i + .2 for i in theme.sec[:-1]] + [1]
    padding: 0, 10

<RootLayout>:
    orientation: 'vertical'

    canvas.after:
        Color:
            rgb: theme.prim

        Rectangle:
            group: 'mouse_highlight'
            source: 'img/mouse_highlight.png'
            pos: self.mouse_highlight_pos
            size: 120, 120

    BoxLayout:
        id: header
        size_hint_y: None
        height: 30

        HeaderLabel:
            id: header_label

        HeaderButton:
            id: minimize_button
            text: '\u2212'
            on_release: Window.minimize()

        HeaderButton:
            id: close_button
            text: '\u00d7'
            on_release: app.stop()

    Navigation:
        id: navigation
        page_layout: content

        NavigationButton:
            text: 'Updater'
            icon: '\ue78b'
            page_index: 0

        NavigationButton:
            text: 'Games'
            icon: '\ue7fc'
            page_index: 1

        NavigationButton:
            text: 'Tweaks'
            icon: '\ue770'
            page_index: 2

        Widget:

        IconNavigationButton:
            text: '\ue734'
            page_index: 3
            disabled: True

        IconNavigationButton:
            text: '\ue713'
            page_index: 4

    Content:
        id: content
        anim_kwargs: {'t': 'out_expo', 'd': .5 * app.conf.animations}

        ContentLayout:
            id: content_updater
            noise_color: theme.sec

            BoxLayout:
                size_hint_y: None
                height: 40

                canvas.before:
                    Color:
                        rgb: theme.dark
                    Rectangle:
                        pos: self.pos
                        size: self.size

                PathInput:
                    id: path_info

                IconButton:
                    id: refresh_button
                    disabled: True
                    text: '\ue72c'
                    on_release: app.root.setup_updater()

                IconButton:
                    text: '\ue8a4'
                    disabled: not subdir_view.data
                    on_release: root.goto_page(6)

                IconButton:
                    text: '\uf12b'
                    on_release: root.load_directory()
                    disabled: not root.dlls_loaded
            
            BoxLayout:
                id: quickupdate_content
                orientation: 'vertical'

                Label:
                    text: '{} dll updates available'.format(len(root.listed_dlls))
                    font_size: 36
                    color: theme.prim

                BoxLayout:
                    padding: 0, 40
                    spacing: 10
                    size_hint_y: None
                    height: 140

                    Widget:

                    BackgroundedButton:
                        text: 'Selective update'
                        on_release: root.load_selective()

                    BackgroundedButton:
                        text: 'Update all'
                        on_release: root.update_callback()

                    Widget:
                
        ContentLayout:
            id: content_games

            GameCollection:
                id: game_collection_view

            BoxLayout:
                size_hint_y: None
                height: 60
                padding: 10

                Widget

                IconButton:
                    text: '\ue710'
                    on_release: root.goto_page(5)

        ContentLayout:
            id: content_system
            
            ScrollView:
                BoxLayout:
                    orientation: 'vertical'
                    padding: 10
                    spacing: 10

                    LabelIconButton:
                        text: "Clear user's temp folder"
                        icon: '\ue74d'
                        command: Tweaks.clear_temps

                    LabelSwitch:
                        text: 'Allow GameDVR'
                        active_callback: Tweaks.switch_dvr
                        active: Tweaks.is_dvr()
                        disabled: not main.IS_ADMIN or platform.release() != '10'

                    LabelIconButton:
                        id: clear_fth_btn
                        text: 'Clear FTH'
                        icon: '\ue74c'
                        disabled: not (Tweaks.fth_value() and main.IS_ADMIN)
                        command: Tweaks.clear_fth
                    
                    Widget:
                        size_hint_y: None
                        height: 300

        ContentLayout:
            id: content_favorite

        ContentLayout:
            id: content_settings

            ScrollView:
                BoxLayout:
                    orientation: 'vertical'
                    padding: 10, 40
                    spacing: 10
                    size_hint_y: None
                    height: sum([child.height for child in self.children]) + self.spacing * len(self.children) + self.padding[1]

                    SectionLabel:
                        text: 'Support'

                    LabelIconButton:
                        text: 'Get a help'
                        icon: '\ue897'
                        command: lambda: startfile('https://discord.gg/Cs4rstF')

                    LabelIconButton:
                        text: 'Request a feature'
                        icon: '\ue943'
                        command: lambda: startfile('https://discord.gg/rdwCuge')

                    LabelIconButton:
                        text: 'Report a bug'
                        icon: '\uebe8'
                        command: lambda: startfile('https://discord.gg/sfcBuMU')

                    LabelIconButton:
                        text: 'Export logs'
                        icon: '\ue9f9'
                        command: root.export_logs

                    SectionLabel:
                        text: 'GUI'

                    LabelSwitch:
                        text: 'Enable animations'
                        active_callback: root.switch_animations_enabled
                        active: app.conf.animations

                    LabelSwitch:
                        text: 'Enable mouse highlight'
                        active_callback: root.switch_mouse_highlight
                        active: app.conf.mouse_highlight

                    LabelSwitch:
                        text: 'Decorate head'
                        active_callback: root.switch_head_decor
                        active: app.conf.head_decor

                    SectionLabel:
                        text: 'Cache'

                    LabelIconButton:
                        text: f"Clear cached images"
                        icon: '\ueb9f'
                        command: root.clear_images_cache

                    LabelIconButton:
                        text: "Clear cached game database"
                        icon: '\ueda2'
                        command: root.clear_common_paths_cache

                    SectionLabel:
                        text: 'License'
                    
                    LabelIconButton:
                        text: 'Show license'
                        icon: '\ue785'
                        command: Factory.DisclaimerPopup().open

                    SectionLabel:
                        text: 'Danger zone'
                        color: 1, .3, .3, 1

                    LabelIconButton:
                        text: f'Reset [color={theme.PRIM}][i]Game Collection[/i][/color]'
                        icon: '\ue777'
                        command: root.reset_custom_paths

                    LabelIconButton:
                        text: 'Uninstall'
                        icon: '\uecc9'
                        command: root.uninstall_prompt

                    Label:
                        text: f'Version: {version}'
                        font_name: 'fnt/Roboto-Medium.ttf'
                        font_size: 16
                        color: theme.bg
                        size_hint_y: None

        ContentLayout:
            ScrollView:
                BoxLayout:
                    orientation: 'vertical'
                    padding: 20, 0
                    spacing: 10
                    size_hint_y: None
                    height: self.minimum_height

                    SectionLabel:
                        text: 'Game name'

                    CustTextInput:
                        id: game_name_input
                        size_hint_y: None
                        height: 40

                    SectionLabel:
                        text: 'Game dll directory'
                    
                    LabelIconButton:
                        id: game_add_form_dir
                        text: ''
                        icon: '\uf12b'
                        command: root.game_path_button_callback
                        font_size: 11

                    SectionLabel:
                        text: 'Game launchable file / URL'

                    BoxLayout:
                        size_hint_y: None
                        height: 40
                        spacing: self.parent.padding[0]

                        LabelIconButton:
                            id: game_add_form_launch
                            text: ''
                            icon: '\ue7c3'
                            disabled: bool(url_input.text)
                            command: root.game_launch_path_button_callback
                            font_size: 11

                        CustTextInput:
                            id: url_input
                    
                    Label:
                        size_hint_y: None
                        height: 30
                        text: 'Launchable is ' + ('an URL' if game_add_form_launch.disabled else 'a file')
                        color: theme.prim
                        text_size: self.size
                        padding: 2, 0

                    SectionLabel:
                        text: 'All filled ?'

                    BoxLayout:
                        size_hint_y: None
                        height: 60
                        padding_y: 10

                        Widget

                        IconButton:
                            text: '\ue711'
                            color: 1, .3, .3, 1
                            on_release: root.cancel_add_game_callback()

                        IconButton:
                            text: '\ue710'
                            color: .3, 1, .3, 1
                            on_release: root.add_game_callback()
                            disabled: not (game_name_input.text and game_add_form_dir.text and (game_add_form_launch.text or url_input.text))

        ContentLayout:
            SubdirView:
                id: subdir_view

        ContentLayout:
            BoxLayout:
                size_hint_y: None
                height: 40

                Widget:

                IconButton:
                    id: invert_selection_button
                    disabled: not dll_view.adapter.data
                    text: '\ue8b3'
                    on_release: root.ids.dll_view.adapter.invert_selection()

            DllView:
                id: dll_view

            BoxLayout:
                size_hint_y: None
                height: 60
                padding: 10, 10
                spacing: 10

                canvas.before:
                    Color:
                        rgba: theme.sec

                    Rectangle:
                        pos: self.pos
                        size: self.size

                Widget

                BackgroundedButton:
                    id: restore_button
                    font_size: 18
                    text: 'Restore'
                    size_hint_x: .5
                    disabled: not dll_view.adapter.selection
                    on_release: root.restore_callback()

                BackgroundedButton:
                    id: update_button
                    text: 'Update'
                    size_hint_x: .5
                    disabled: not dll_view.adapter.selection
                    on_release: root.update_callback(from_selection=True)


    BoxLayout:
        size_hint_y: None
        height: 0

        WorkingBar:
            id: bar
            value: 50
            color: theme.prim            
